<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/chota@latest">
    <script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js" type="text/javascript"> </script>
    <script src="zepto.min.js" type="text/javascript"> </script>
    <script src="qr-scanner.umd.min.js"></script> <!-- https://github.com/nimiq/qr-scanner -->
    <script type="text/javascript">
      //Edit this \/
      const factory_addr="0x4E79094b0B7D9a1C8564FFC39f762A20590e8788";
      const factory_abi=[ { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "_handles", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "", "type": "string" } ], "name": "attestation_structures", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "handle", "type": "string" }, { "internalType": "string[]", "name": "props", "type": "string[]" } ], "name": "create_attestation_structure", "outputs": [ { "internalType": "contract AttestationStructure", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "handles", "outputs": [ { "internalType": "string[]", "name": "", "type": "string[]" } ], "stateMutability": "view", "type": "function" } ];
      const attestatation_struct_abi=[ { "inputs": [ { "internalType": "address", "name": "", "type": "address" } ], "name": "_num_attestations_about", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "", "type": "address" } ], "name": "_num_attestations_by", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "int256", "name": "idx", "type": "int256" }, { "internalType": "address", "name": "attestee", "type": "address" } ], "name": "attest", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "attestee", "type": "address" } ], "name": "attestations_about", "outputs": [ { "internalType": "uint256[]", "name": "", "type": "uint256[]" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "attestor", "type": "address" } ], "name": "attestations_by", "outputs": [ { "internalType": "uint256[]", "name": "", "type": "uint256[]" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "address", "name": "attestee", "type": "address" }, { "internalType": "uint256", "name": "attestation_ind", "type": "uint256" } ], "name": "attestors_of", "outputs": [ { "internalType": "address[]", "name": "", "type": "address[]" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string", "name": "handle", "type": "string" }, { "internalType": "string[]", "name": "prop_names", "type": "string[]" } ], "name": "init", "outputs": [ { "internalType": "contract AttestationStructure", "name": "", "type": "address" } ], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "instances", "outputs": [ { "components": [ { "internalType": "string[]", "name": "prop_values", "type": "string[]" }, { "internalType": "address[]", "name": "attestors", "type": "address[]" }, { "internalType": "address[]", "name": "attestees", "type": "address[]" } ], "internalType": "struct attestation_instance[]", "name": "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" }, { "inputs": [ { "internalType": "string[]", "name": "vals", "type": "string[]" } ], "name": "new_instance", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "prop_names", "outputs": [ { "internalType": "string[]", "name": "", "type": "string[]" } ], "stateMutability": "view", "type": "function" } ];

      const zero_addr="0x0000000000000000000000000000000000000000";
      var provider, signer, factory_ro, factory_rw, attestation_ro, attestation_rw, my_addr, local_handles;
      //poor man's html factory
      ['h1','h2','h3','div','p','ul','li','input','button','a','table','thead','tbody','th','td','tr'].forEach((tag) => {
        window[tag]=(attrs, ...content) => {
          return $('<'+tag+' />', attrs).append(content.flat());
        }
      })

      Zepto(function($){
        $(document).on("click",'button', function(e) {e.target.id && button_actions[e.target.id].call(null,e)});
        $(document).on("click",'button', function(e) {e.target.attributes["class"] && button_actions[e.target.attributes["class"].textContent.split(' ')[0]] && button_actions[e.target.attributes["class"].textContent.split(' ')[0]].call(null,e)});
        provider = new ethers.providers.Web3Provider(window.ethereum);
        provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        signer.getAddress().then(a => my_addr=a);
        factory_ro=new ethers.Contract(factory_addr, factory_abi, provider);
        factory_rw=new ethers.Contract(factory_addr, factory_abi, signer);
        show_handles();
        $('#mm_connect').hide();
        $("#show_new_attestation_struct").show();
      })
      const button_actions={
        "show_new_attestation_struct": function(e) {
          $("#new_attestation_struct_form").show();
          $("#show_new_attestation_struct").hide();
        },
        "save_attestation_struct": function(e) {
          factory_rw.create_attestation_structure($('#handle')[0].value,$("#props")[0].value.split("|").map(h => h.trim())).then(
            function() {
              show_handles();
              $("#new_attestation_struct_form").hide();
              $("#show_new_attestation").show();
            }
          );
        },
        "handle": function(e) {
          $(e.target).toggleClass('active');
          if (e.target.className.match('active')) {
            show_instances(e.target);
          } else {
            $(e.target).parent().children('.instances').hide();
          }
        },
        "save_instance": function(e) {
          att_contract_rw(e).new_instance(Array.from($(e.target).parents(".instance_form").find('input').map((i, j) => j.value)));
        },
        "request_attestation": function(e) {

        },
        "show_attestations": function(e) {

        },
        "address_input": function(e) { // buttons with this class all require an address input, and their second class name contains the function to call with the acquired address
          $("#call_addr_action").removeClass().addClass(e.target.classList[1]);
          $(e.target).after($("#address_input").show());
        },
        "call_addr_action":function(e){
          address_actions[e.target.className].call(null, e);
          $("#address_input").hide();
        },
        "scan": function(e) {
          var qr_reader=new QrScanner($('video')[0], function(result) {$("#address")[0].value=result; qr_reader.stop()});
          qr_reader.start();
        },
    }
    const address_actions={
        "attestations_about": function(e) {console.log("1")},
        "attestations_by": function(e) {console.log("2")},
        "attest": function(e) {
          if (e.target.value > "") {

          }
        },

    }
    function att_contract(e) {return $(e.target).parents('li').children('.handle')[0].contract;}
    function att_contract_rw(e) {return $(e.target).parents('li').children('.handle')[0].contract_rw;}
    function show_handles(){
      factory_ro.handles().then(a => {
      local_handles=a;
      $("#handles").empty();
      $("#handles").append(h2({},"Existing Attestation Structures"));
      $("#handles").append(ul({}, local_handles.map(h => li({}, button({"class":"handle"},h)))))});
    }
    function show_instances(target) {
      if ($(target).parent().children('.instances').length > 0) {
        $(target).parent().children('.instances').show()
      } else {
        factory_ro.attestation_structures(target.textContent).then( 
        addr =>new ethers.Contract(addr, attestatation_struct_abi, provider)).then(
        att_struct => {
          target.contract=att_struct;
          target.contract_rw=new ethers.Contract(att_struct.address, attestatation_struct_abi, signer);
          att_struct.prop_names().then(
          names => $(target).parent().append(
            div({"class":"instances"},h3({},"Instances"),button({"class":"address_input attestations_about"}, "Attestations About..."),button({"class":"address_input attestations_by"}, "Attestations By..."),
            table({},
              thead({},names.map(name => th({},name))).append(td({},"Actions")),
              tbody()
            )
          ))); return att_struct;
        }).then(
            att_struct => att_struct.instances().then(
              instances => $(target).parent().find('tbody').append(
                instances.map((instance,i) => tr({"id":att_struct.address + "-" + i}, instance.prop_values.map(val => td({},val))).append(td({},button({"class":"address_input show_attestations"}, "Show Attestations"),button({"class":"address_input attest"}, "Attest"),button({"class":"address_input request_attestion"}, "Request Attestation")))),
                tr({"class":"instance_form"},$(target).parent().find('th').map(col => td({}, input()))).append(td({},button({"class":"save_instance"}, "Save New Instance"))) //one for each header
              )
            )
          )
        }
      }
    </script>
  </head>
  <body>
    <h1>Attestation Management</h1>
    <button id="show_new_attestation_struct">New Attestation Structure</button>
    <div id="new_attestation_struct_form" hidden="true">
      <h3>New Attestation Structure</h3>
      <label for="props">Property Names (pipe separated):</label><input type="text" id="props" name="props" />
      <label for="handle">Handle:</label><input type="text" id="handle" name="handle" />
      <button id="save_attestation_struct">Save</button>
    </div>
    <div id="address_input" hidden="true">
      <label for="address">Address:</label><input type="text" id="address" name="address" />
      <video></video>
      <button id="scan">Scan</button>
      <button id="call_addr_action">OK</button>
    </div>
    <div id="handles"></div>
  </body>
</html>

